<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinZ | News</title>
    <style>
        :root {
            /* Light Theme Palette */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f5;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.07);
            --cta-bg-start: #495057;
            --cta-bg-end: #343a40;
            --cta-text: #ffffff;
            --link-color: #3b82f6;
            --hover-color: #000000;
        }

        html[data-theme="dark"] {
            /* Dark Theme Palette */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2e;
            --text-primary: #e0e0e0;
            --text-secondary: #888888;
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --cta-bg-start: #5a626b;
            --cta-bg-end: #495057;
            --cta-text: #ffffff;
            --link-color: #60a5fa;
            --hover-color: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary); color: var(--text-primary); min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
            display: flex; flex-direction: column;
        }
        
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }
        
        .navbar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 2rem; }
        .logo { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
        .nav-links { display: flex; align-items: center; gap: 1.5rem; }
        .nav-links a { color: var(--text-primary); font-weight: 600; text-decoration: none; transition: color 0.3s ease; }
        .nav-links a:hover { color: var(--hover-color); }
        #theme-toggle { background: none; border: none; cursor: pointer; color: var(--text-secondary); }
        #theme-toggle:hover { color: var(--text-primary); }
        #theme-toggle .icon { width: 24px; height: 24px; }
        #moon-icon { display: none; }
        
        .hidden { display: none !important; }

        .main-title { font-size: 2.25rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-primary); }
        .filter-section { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 15px var(--shadow-color); }

        #search-form { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        #search-form label { font-weight: 600; color: var(--text-secondary); }

        .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .input-field { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--text-primary); font-family: inherit; font-size: 0.9rem; }
        #keyword-search { min-width: 250px; }
        .date-inputs { display: flex; align-items: center; gap: 0.5rem; }
        
        html[data-theme="dark"] input[type="date"] { color-scheme: dark; }

        .search-button { background: linear-gradient(135deg, var(--cta-bg-start) 0%, var(--cta-bg-end) 100%); color: var(--cta-text); padding: 0.6rem 1.5rem; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 1.25rem; }
        .search-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow-color); }
        
        .news-feed-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        #news-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
        
        /* --- NEW SORTING STYLES --- */
        .sort-controls { display: flex; align-items: center; gap: 0.5rem; }
        .sort-controls label { font-size: 0.9rem; color: var(--text-secondary); font-weight: 600; }
        #sort-by {
            background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px;
            padding: 0.4rem 0.6rem; color: var(--text-primary); font-family: inherit; font-size: 0.9rem;
            cursor: pointer;
        }

        .news-card {
            background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem;
            overflow: hidden; box-shadow: 0 4px 15px var(--shadow-color);
            display: flex; flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-decoration: none;
        }
        .news-card:hover { transform: translateY(-5px); }
        .card-image { width: 100%; height: 180px; object-fit: cover; background-color: var(--bg-tertiary); }
        .card-content { padding: 1rem; display: flex; flex-direction: column; flex: 1; }
        .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
        .news-card:hover .card-title { color: var(--link-color); }
        .card-meta { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .card-description { font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary); margin-top: auto; }

        .news-state-placeholder { grid-column: 1 / -1; text-align: center; padding: 4rem 1rem; color: var(--text-secondary); }
        .news-state-placeholder svg { width: 50px; height: 50px; margin: 0 auto 1rem; display: block; }
        .loader-spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--link-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="navbar">
            <div class="logo">FinZ | Stonks</div>
            <div class="nav-links">
                <a href="/stonks.html">Home</a>
                <a href="/stonks_learn.html">Learn</a>
                <a href="/stonks_invest.html">Invest</a>
                <button id="theme-toggle" title="Toggle theme">
                    <svg id="sun-icon" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moon-icon" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </div>

        <main>
            <h1 class="main-title">Latest Headlines</h1>
            <section class="filter-section">
                <form id="search-form">
                    <div class="input-group"><label for="keyword-search">Search by Keyword</label><input type="text" id="keyword-search" class="input-field" placeholder="e.g., bitcoin, Apple, crypto"></div>
                    <div class="input-group"><label for="date-from">Date Range</label><div class="date-inputs"><input type="date" id="date-from" name="date-from" class="input-field" required><span>to</span><input type="date" id="date-to" name="date-to" class="input-field" required></div></div>
                    <button type="submit" class="search-button">Search News</button>
                </form>
            </section>

            <section class="news-feed-section">
                <div class="news-feed-header">
                    <h2 style="font-weight: 600;">News Feed</h2>
                    <!-- --- SORTING DROPDOWN (Initially hidden) --- -->
                    <div id="sort-controls" class="sort-controls hidden">
                        <label for="sort-by">Sort by</label>
                        <select id="sort-by" class="input-field">
                            <option value="popularity" selected>Popularity</option>
                            <option value="newest">Newest to Oldest</option>
                            <option value="oldest">Oldest to Newest</option>
                        </select>
                    </div>
                </div>
                <div id="news-container">
                    <div class="news-state-placeholder" id="news-placeholder"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg><h3>Enter a search to see the latest news.</h3></div>
                    <div class="news-state-placeholder hidden" id="news-loader"><div class="loader-spinner"></div><h3 style="margin-top: 1rem;">Loading News...</h3></div>
                    <div class="news-state-placeholder hidden" id="news-no-results"><h3>No news found for your search criteria.</h3></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- THEME SWITCHER ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        function updateThemeUI(theme) {
            sunIcon.style.display = theme === 'dark' ? 'none' : 'block';
            moonIcon.style.display = theme === 'dark' ? 'block' : 'none';
            document.documentElement.setAttribute('data-theme', theme);
        }
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = (document.documentElement.getAttribute('data-theme') || 'light') === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        });

        // --- NEWS FEED LOGIC ---
        const searchForm = document.getElementById('search-form');
        const newsContainer = document.getElementById('news-container');
        const placeholder = document.getElementById('news-placeholder');
        const loader = document.getElementById('news-loader');
        const noResults = document.getElementById('news-no-results');
        const sortControls = document.getElementById('sort-controls');
        const sortBySelect = document.getElementById('sort-by');

        let currentArticles = []; // Store the original fetched articles

        function setNewsState(state) {
            placeholder.classList.toggle('hidden', state !== 'initial');
            loader.classList.toggle('hidden', state !== 'loading');
            noResults.classList.toggle('hidden', state !== 'no-results');
            sortControls.classList.toggle('hidden', state !== 'results'); // Show/hide sort controls
            if (state !== 'results') {
                newsContainer.querySelectorAll('.news-card').forEach(card => card.remove());
            }
        }

        // Renders the news cards to the DOM
        function renderNews(articles) {
            newsContainer.querySelectorAll('.news-card').forEach(card => card.remove());
            if (articles.length === 0) {
                setNewsState('no-results');
                return;
            }
            
            const fragment = document.createDocumentFragment();
            articles.forEach(article => {
                const fallbackImage = 'https://via.placeholder.com/400x225/ced4da/6c757d?text=No+Image';
                const formattedDate = new Date(article.publishedAt).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                let summary = article.description || '';
                if (!summary && article.content) {
                    summary = article.content.split('[+')[0].trim().substring(0, 150) + '...';
                }

                const card = document.createElement('a');
                card.href = article.url;
                card.target = "_blank";
                card.rel = "noopener noreferrer";
                card.className = "news-card";
                card.innerHTML = `
                    <img src="${article.urlToImage || fallbackImage}" alt="" class="card-image" onerror="this.onerror=null;this.src='${fallbackImage}';">
                    <div class="card-content">
                        <h3 class="card-title">${article.title}</h3>
                        <div class="card-meta">
                            <span>By <strong>${article.source.name || 'Unknown Source'}</strong></span>
                            <span>${formattedDate}</span>
                        </div>
                        <p class="card-description">${summary}</p>
                    </div>`;
                fragment.appendChild(card);
            });
            newsContainer.appendChild(fragment);
            setNewsState('results');
        }

        // Sorts and displays the current articles based on dropdown value
        function displaySortedArticles() {
            const sortBy = sortBySelect.value;
            // Create a shallow copy to avoid mutating the original `currentArticles` array
            let articlesToRender = [...currentArticles];

            if (sortBy === 'newest') {
                articlesToRender.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
            } else if (sortBy === 'oldest') {
                articlesToRender.sort((a, b) => new Date(a.publishedAt) - new Date(b.publishedAt));
            }
            // For 'popularity', we do nothing and use the original order from the API

            renderNews(articlesToRender);
        }

        searchForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const keyword = document.getElementById('keyword-search').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;

            setNewsState('loading');
            try {
                const params = new URLSearchParams({ keyword, from: dateFrom, to: dateTo });
                const response = await fetch(`/news-fetch?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const data = await response.json();
                currentArticles = data.news; // Store the original results
                sortBySelect.value = 'popularity'; // Reset dropdown to default
                displaySortedArticles(); // Display initial, popularity-sorted results

            } catch (error) {
                console.error("Failed to fetch news:", error);
                currentArticles = []; // Clear articles on error
                setNewsState('initial');
                alert('An error occurred while fetching news. Please check the console for details.');
            }
        });
        
        // Add event listener for the sort dropdown
        sortBySelect.addEventListener('change', displaySortedArticles);
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            updateThemeUI(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
            
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            
            document.getElementById('date-from').value = monthAgo.toISOString().split('T')[0];
            document.getElementById('date-to').value = today;
        });
    </script>
</body>
</html>